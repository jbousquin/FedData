---
title: "Introduction to FedData"
output: 
  rmarkdown::html_document:
    self_contained: false
    toc: true
    toc_float: true
    theme: 'default'
vignette: >
  %\VignetteIndexEntry{Introduction to FedData}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

`FedData` is a package for downloading data from federated (usually US Federal) data sets, using a consistent, spatial-first API. In this vignette, you'll learn how to load the `FedData` package, download data for an "template" area of interest, and make simple web maps using the [`mapview`](https://r-spatial.github.io/mapview/) package.

#### Load `FedData` and define a study area
```{r setup, results="hide", message=FALSE}
# Load FedData and magrittr
library(FedData)
library(magrittr)

# Install mapview if necessary
if (!require("mapview")) {
  install.packages("mapview")
}
library(mapview)
mapviewOptions(basemaps = c())

# Create a nice mapview template
plot_map <-
  function(x, ...) {
    bounds <-
      FedData::meve %>%
      sf::st_bbox() %>%
      as.list()

    mapview::mapview(x, ...)@map %>%
      leaflet::removeLayersControl() %>%
      leaflet::addTiles(
        urlTemplate = "https://basemap.nationalmap.gov/ArcGIS/rest/services/USGSShadedReliefOnly/MapServer/tile/{z}/{y}/{x}"
      ) %>%
      leaflet::addProviderTiles("Stamen.TonerLines") %>%
      leaflet::addProviderTiles("Stamen.TonerLabels") %>%
      leaflet::addPolygons(
        data = FedData::meve,
        color = "black",
        fill = FALSE
      ) %>%
      leaflet::fitBounds(
        lng1 = bounds$xmin,
        lng2 = bounds$xmax,
        lat1 = bounds$ymin,
        lat2 = bounds$ymax
      )
  }


# FedData comes loaded with the boundary of Mesa Verde National Park, for testing
FedData::meve

plot_map(FedData::meve,
  legend = FALSE
)
```

#### Get and plot the National Elevation Dataset for the study area
```{r NED, results="hide", message=FALSE}
# Get the NED (USA ONLY)
# Returns a raster
NED <- get_ned(
  template = FedData::meve,
  label = "meve"
)

plot_map(NED,
  layer.name = "NED Elevation (m)",
  maxpixels = raster::ncell(NED)
)
```

#### Get and plot the Daymet dataset for the study area
```{r DAYMET, results="hide", message=FALSE, warning=FALSE}
# Get the DAYMET (North America only)
# Returns a raster
DAYMET <- get_daymet(
  template = FedData::meve,
  label = "meve",
  elements = c("prcp", "tmax"),
  years = 1980:1985
)

plot_map(DAYMET$tmax$X1985.10.23,
  layer.name = "TMAX on 23 Oct 1985 (ÂºC)",
  maxpixels = raster::ncell(DAYMET$tmax)
)
```

#### Get and plot the daily GHCN precipitation data for the study area
```{r GHCN-precipitation, results="hide", message=FALSE}
# Get the daily GHCN data (GLOBAL)
# Returns a list: the first element is the spatial locations of stations,
# and the second is a list of the stations and their daily data
GHCN.prcp <- get_ghcn_daily(
  template = FedData::meve,
  label = "meve",
  elements = c("prcp")
)

plot_map(GHCN.prcp$spatial,
  label = GHCN.prcp$spatial %$%
    paste0(ID, ": ", NAME),
  legend = FALSE
)
```

#### Get and plot the daily GHCN temperature data for the study area
```{r GHCN-temperature, results="hide", message=FALSE}
# Elements for which you require the same data
# (i.e., minimum and maximum temperature for the same days)
# can be standardized using standardize==T
GHCN.temp <- get_ghcn_daily(
  template = FedData::meve,
  label = "meve",
  elements = c("tmin", "tmax"),
  years = 1980:1985,
  standardize = TRUE
)

plot_map(GHCN.temp$spatial,
  label = GHCN.temp$spatial %$%
    paste0(ID, ": ", NAME),
  legend = FALSE
)
```

#### Get and plot the National Hydrography Dataset for the study area
```{r NHD, results="hide", message=FALSE}
# Get the NHD (USA ONLY)
NHD <-
  get_nhd(
    template = FedData::meve,
    label = "meve"
  )

# FedData comes with a simple plotting function for NHD data
plot_nhd(NHD, template = FedData::meve)

# Or, do an interactive map
NHD[purrr::map_lgl(NHD, ~ (nrow(.x) != 0))] %>%
  plot_map()
```

#### Get and plot the NRCS SSURGO data for the study area
```{r SSURGO, results="hide", message=FALSE, warning=FALSE}
# Get the NRCS SSURGO data (USA ONLY)
SSURGO.MEVE <- get_ssurgo(
  template = FedData::meve,
  label = "meve"
)

SSURGO.MEVE$spatial %>%
  dplyr::left_join(
    SSURGO.MEVE$tabular$mapunit %>%
      dplyr::mutate(mukey = as.character(mukey)),
    by = c("MUKEY" = "mukey")
  ) %>%
  dplyr::mutate(label = paste0(MUKEY, ": ", muname)) %>%
  plot_map(
    zcol = "label",
    legend = FALSE
  )
```

#### Get and plot the NRCS SSURGO data for particular soil survey areas
```{r SSURGO-area, results="hide", message=FALSE}
# Or, download by Soil Survey Area names
SSURGO.areas <- get_ssurgo(
  template = c("CO670"),
  label = "CO670"
)

SSURGO.areas$spatial %>%
  dplyr::left_join(
    SSURGO.areas$tabular$muaggatt %>%
      dplyr::mutate(mukey = as.character(mukey)),
    by = c("MUKEY" = "mukey")
  ) %>%
  dplyr::mutate(label = paste0(MUKEY, ": ", muname)) %>%
  mapview::mapview(
    zcol = "brockdepmin",
    layer.name = "Minimum Bedrock Depth (cm)",
    label = "label"
  )
```

#### Get and plot the ITRDB chronology locations in the study area
```{r ITRDB, results="hide", message=FALSE}
# Get the ITRDB records
# Buffer MEVE, because there aren't any chronologies in the Park
ITRDB <-
  get_itrdb(
    template = FedData::meve %>%
      sf::st_buffer(50000),
    label = "meve",
    measurement.type = "Ring Width",
    chronology.type = "Standard"
  )

plot_map(ITRDB$metadata,
  zcol = "SPECIES",
  layer.name = "Species",
  label = "NAME"
) %>%
  leaflet::setView(
    lat = sf::st_centroid(FedData::meve) %>%
      sf::st_coordinates() %>%
      as.numeric() %>%
      magrittr::extract2(2),
    lng = sf::st_centroid(FedData::meve) %>%
      sf::st_coordinates() %>%
      as.numeric() %>%
      magrittr::extract2(1),
    zoom = 9
  )
```

#### Get and plot the National Land Cover Dataset for the study area
```{r NLCD, results="hide", message=FALSE}
# Get the NLCD (USA ONLY)
# Returns a raster
NLCD <- get_nlcd(
  template = FedData::meve,
  year = 2011,
  label = "meve"
)

NLCD <- raster::as.factor(NLCD)
NLCD@data@attributes[[1]] <- as.data.frame(nlcd_colors())
raster::colortable(NLCD) <- NLCD@data@attributes[[1]] %>%
  dplyr::left_join(nlcd_colors()) %$%
  Color

# Plot with raster::plot
plot_map(NLCD,
  col.regions = raster::colortable(NLCD),
  att = "Class",
  layer.name = "Landcover Class"
)
```

#### Get and plot the NASS Cropland Data Layer for the study area
```{r NASS-CDL, results="hide", message=FALSE}
# Get the NASS (USA ONLY)
# Returns a raster
NASS_CDL <- get_nass_cdl(
  template = FedData::meve,
  year = 2016,
  label = "meve"
)

NASS_CDL@data@attributes[[1]] %<>%
  dplyr::filter(ID %in% NASS_CDL[])

plot_map(NASS_CDL,
  col.regions = c(
    "#FFD300FF", "#FF9E0BFF", "#E2007CFF", "#D8B56BFF", "#A57000FF", "#A05989FF",
    "#FFA5E2FF", "#A5F28CFF", "#A50000FF", "#BFBF77FF", "#4B70A3FF", "#9A9A9AFF",
    "#9B9B9BFF", "#9C9C9CFF", "#CCBFA3FF", "#93CC93FF", "#93CC94FF", "#93CC95FF",
    "#C6D69EFF", "#E8FFBFFF", "#7EB1B1FF", "#7EB2B2FF", "#D69EBCFF"
  ),
  att = "Land Cover",
  layer.name = "Landcover Class"
)
```


#### Get and plot the USGS PAD-US dataset for the study area
```{r PADUS, results="hide", message=FALSE, warning=FALSE}
# Get the PAD-US data (USA ONLY)
PADUS <- get_padus(
  template = sf::st_buffer(FedData::meve, 1000),
  label = "meve"
)

mapview::mapview(
  PADUS$Fee_Manager,
  layer.name = "Unit Name",
  zcol = "Unit_Nm"
)

# Optionally, specify your unit names
PADUS_meve_ute <- get_padus(
  template = c("Mesa Verde National Park", "Ute Mountain Reservation"),
  label = "meve_ute"
)

mapview::mapview(
  PADUS_meve_ute$Fee_Manager,
  layer.name = "Unit Name",
  zcol = "Unit_Nm"
)
```

